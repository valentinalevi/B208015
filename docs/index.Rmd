---
title: "Assessment"
output: html_document
author: "Valentina Levi"
date: "2024-11-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Investigation Question: 
Do regions in northern Scotland, which experience longer winter nights, show higher seasonal increases in antidepressant prescriptions compared to southern regions?

#### Introduction
Seasonal Affective Disorder (SAD) is a type of depression that occurs during certain seasons, usually fall or winter.

We can therefore hypothesise that regions in northern Scotland, with more intense seasonal changes and longer winters, may experience higher prescription rates of antidepressants during winter months due to SAD. 

The data that will be used is "Prescriptions in the Community" from NHS Public Health Scotland. I have chosen to use the year 2023 because it is the most recent complete year with all 4 seasons. 

The Health Boards Area (2019) data from Scotland's Census will be used to define northern and southern regions in Scotland. 

#### Loading in the data sets, creating columns and joining 
```{r}
library(tidyverse)
library(janitor) # For cleaning the data
library(gt) # For tables
library(here) # For directory structure
library(readr)
library(dplyr)
library(sf)
library(viridis) 

#Reading in healthboards data
healthboards <- read.csv(here("data/healthboards.csv")) %>% 
  clean_names()

# Define northern and southern regions based on Health Boards
northern_boards <- c("NHS Grampian", "NHS Highland", "NHS Orkney", "NHS Shetland", "NHS Western Isles")
southern_boards <- c("NHS Ayrshire and Arran", "NHS Borders", "NHS Dumfries and Galloway", 
                     "NHS Fife", "NHS Forth Valley", "NHS Greater Glasgow and Clyde", 
                     "NHS Lanarkshire", "NHS Lothian", "NHS Tayside")

# Add a Region column to the Health Board data
healthboards <- healthboards %>%
  mutate(Region = case_when(
    hb_name %in% northern_boards ~ "Northern",
    hb_name %in% southern_boards ~ "Southern",
    TRUE ~ "Other"
  ))

#Reading in prescriptions data from each month in the year 2023.
january <- read.csv(here("data/january.csv")) %>% 
  clean_names()

february <- read.csv(here("data/february.csv")) %>% 
  clean_names()

march <- read.csv(here("data/march.csv")) %>% 
  clean_names()

april <- read.csv(here("data/april.csv")) %>% 
  clean_names()

may <- read.csv(here("data/may.csv")) %>% 
  clean_names()

june <- read.csv(here("data/june.csv")) %>% 
  clean_names()

july <- read.csv(here("data/july.csv")) %>% 
  clean_names()

august <- read.csv(here("data/august.csv")) %>% 
  clean_names()

september <- read.csv(here("data/september.csv")) %>% 
  clean_names()

october <- read.csv(here("data/october.csv")) %>% 
  clean_names()

november <- read.csv(here("data/november.csv")) %>% 
  clean_names()

december <- read.csv(here("data/december.csv")) %>% 
  clean_names()

# List of monthly data frames
monthly_data <- list(
  january %>% mutate(Month = 1),
  february %>% mutate(Month = 2),
  march %>% mutate(Month = 3),
  april %>% mutate(Month = 4),
  may %>% mutate(Month = 5),
  june %>% mutate(Month = 6),
  july %>% mutate(Month = 7),
  august %>% mutate(Month = 8),
  september %>% mutate(Month = 9),
  october %>% mutate(Month = 10),
  november %>% mutate(Month = 11),
  december %>% mutate(Month = 12)
)


# Combine datasets for each season

# Winter: December, January, February
winter <- bind_rows(
  january %>% mutate(Month = 1),
  february %>% mutate(Month = 2),
  december %>% mutate(Month = 12)
) %>% mutate(Season = "Winter")

# Spring: March, April, May
spring <- bind_rows(
  march %>% mutate(Month = 3),
  april %>% mutate(Month = 4),
  may %>% mutate(Month = 5)
) %>% mutate(Season = "Spring")

#Summer: June, July, August
summer <- bind_rows(
  june %>% mutate(Month = 6, dmd_code = as.character(dmd_code)),
  july %>% mutate(Month = 7, dmd_code = as.character(dmd_code)),
  august %>% mutate(Month = 8, dmd_code = as.character(dmd_code))
) %>% mutate(Season = "Summer")

# Autumn: September, October, November
autumn <- bind_rows(
  september %>% mutate(Month = 9),
  october %>% mutate(Month = 10),
  november %>% mutate(Month = 11)
) %>% mutate(Season = "Autumn")

# Removing the `dmd_code` column from each seasonal dataset
winter <- winter %>% select(-dmd_code)
spring <- spring %>% select(-dmd_code)
summer <- summer %>% select(-dmd_code)
autumn <- autumn %>% select(-dmd_code)

# Combine all seasonal data sets into one
combined_2023 <- bind_rows(winter, spring, summer, autumn)

#Joining the combined seasonal data to the healthboard data
joined_2023 <- full_join(healthboards,combined_2023, by = join_by(hb == hbt))


```

#### Filtering the data to focus on antidepressants.
From research online I have discovered that the typical antidepressants prescribed for people diagnosed with SAD are selective serotonin reuptake inhibitors (SSRIs). In particular, sertraline and fluoxetine. 

```{r}
# Filtering out only the data with fluoxetine and sertaline in the description of the drug 
antidepressant_2023 <- joined_2023 %>%
  filter(
    str_detect(bnf_item_description, "FLUOXETINE") | 
    str_detect(bnf_item_description, "SERTRALINE")
  )
```

#### Calculating the total antidepressant prescriptions for Fluoxetine and Sertraline by healthbaord, season and region

```{r}
seasonal_totals <- antidepressant_2023 %>%
  group_by(hb_name, Region, Season) %>%
  summarise(Total_Prescriptions = sum(paid_quantity, na.rm = TRUE)) %>%
  ungroup()


#Reading in population data 
population <- read_csv(here("data/UV103_age_health_board_census.csv"), skip = 10) %>% 
  # Rename the last column to avoid the messy name in column 6
  # and to match column names with the prescription dataset
  rename(Spare = "...6",
         hb_name = "Health Board Area 2019",
         hb_population = Count) %>% 
  # filter the data so that we get the population of the entire health board
  filter(Age == "All people" & Sex == "All people") %>% 
  # select only the relevant columns
  select(hb_name, hb_population) %>% 
  # change health board names so they match the prescription data
  mutate(hb_name = paste("NHS", hb_name))

#Joining population data and the total antidepressant prescriptions for Fluoxetine and Sertraline by healthbaord, season and region
joined_data <- full_join(population,seasonal_totals, by = join_by(hb_name))


# Calculate the prescription rate per person by healthboard, season and region.
prescription_rates <- joined_data %>%
  mutate(prescriptions_per_person = Total_Prescriptions / hb_population)
```


```{r}
NHS_healthboards <- st_read("~/Desktop/data_science/B208015/data/NHS_healthboards_2019.shp")

NHS_healthboards <- NHS_healthboards %>%
  mutate(hb_name = paste("NHS", hb_name))

NHS_healthboards <- NHS_healthboards %>%
  rename(hb_name = HBName)

prescription_rates_map <- NHS_healthboards %>%
  left_join(prescription_rates, by = "hb_name")

# Prepare the data for the legend
healthboard_legend <- prescription_rates_map %>%
  select(hb_name, Region) %>%
  arrange(Region, hb_name)

# Create the custom legend using gt
legend_table <- healthboard_legend %>%
  gt() %>%
  tab_header(
    title = "Health Boards by Region"
  ) %>%
  cols_label(
    hb_name = "Health Board",
    Region = "Region"
  ) %>%
  data_color(
    columns = vars(Region),
    colors = c("Northern" = "lightblue", "Southern" = "lightcoral")
  )

library(patchwork)

map_plot <- ggplot(data = prescription_rates_map) +
  geom_sf(aes(fill = prescriptions_per_person), color = "black", linewidth = 0.2) +
  scale_fill_viridis(name = "Prescriptions per Person", option = "C", labels = scales::comma) +
  facet_wrap(~ Season, ncol = 2) +
  theme_minimal() +
  labs(
    title = "Seasonal Antidepressant Prescription Rates per Person by Health Board",
    subtitle = "Comparison of Northern and Southern Scotland Regions by Season",
    caption = "Data source: NHS Scotland"
  ) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    strip.background = element_rect(fill = "lightblue", color = "black"),
    strip.text = element_text(size = 12, face = "bold"),
    legend.position = "bottom"
  )

# Combine the map and legend using patchwork
final_plot <- map_plot + legend_table + plot_layout(widths = c(3, 1))

# Display the final combined plot
print(final_plot)

```










